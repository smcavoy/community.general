---
- name: Comprehensive lxd_storage module integration tests
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    test_pool: integration-test-pool
    test_volume: integration-test-volume
    lxd_socket: unix:/var/snap/lxd/common/lxd/unix.socket
  
  tasks:
    - name: Test 1 - Create storage pool (check mode)
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        driver: dir
        config:
          source: "/var/snap/lxd/common/lxd/storage-pools/{{ test_pool }}"
        description: "Integration test pool"
        state: present
        snap_url: "{{ lxd_socket }}"
      check_mode: true
      register: pool_check
      
    - name: Verify check mode did not create pool
      assert:
        that:
          - pool_check.changed == true
          - pool_check.old_state == "absent"
          - "'create' in pool_check.actions"
        fail_msg: "Check mode should show changes but not apply them"
        
    - name: Test 2 - Create storage pool (actual)
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        driver: dir
        config:
          source: "/var/snap/lxd/common/lxd/storage-pools/{{ test_pool }}"
        description: "Integration test pool"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: pool_create
      
    - name: Verify pool creation
      assert:
        that:
          - pool_create.changed == true
          - pool_create.old_state == "absent"
          - "'create' in pool_create.actions"
        fail_msg: "Pool should have been created"
        
    - name: Test 3 - Update pool description (idempotent test)
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        description: "Integration test pool"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: pool_idempotent
      
    - name: Verify idempotency
      assert:
        that:
          - pool_idempotent.changed == false
          - pool_idempotent.old_state == "present"
          - pool_idempotent.actions | length == 0
        fail_msg: "Pool should not have changed"
        
    - name: Test 4 - Update pool description (actual change)
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        description: "Updated integration test pool"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: pool_update
      
    - name: Verify pool update
      assert:
        that:
          - pool_update.changed == true
          - pool_update.old_state == "present"
          - "'apply_configs' in pool_update.actions"
        fail_msg: "Pool description should have been updated"
        
    - name: Test 5 - Create storage volume
      community.general.lxd_storage:
        name: "{{ test_volume }}"
        type: volume
        pool: "{{ test_pool }}"
        config:
          size: 1GiB
        description: "Integration test volume"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: volume_create
      
    - name: Verify volume creation
      assert:
        that:
          - volume_create.changed == true
          - volume_create.old_state == "absent"
          - "'create' in volume_create.actions"
        fail_msg: "Volume should have been created"
        
    - name: Test 6 - Update volume size
      community.general.lxd_storage:
        name: "{{ test_volume }}"
        type: volume
        pool: "{{ test_pool }}"
        config:
          size: 2GiB
        description: "Integration test volume"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: volume_update
      
    - name: Verify volume update
      assert:
        that:
          - volume_update.changed == true
          - volume_update.old_state == "present"
          - "'apply_configs' in volume_update.actions"
        fail_msg: "Volume size should have been updated"
        
    - name: Test 7 - Volume idempotency test
      community.general.lxd_storage:
        name: "{{ test_volume }}"
        type: volume
        pool: "{{ test_pool }}"
        config:
          size: 2GiB
        description: "Integration test volume"
        state: present
        snap_url: "{{ lxd_socket }}"
      register: volume_idempotent
      
    - name: Verify volume idempotency
      assert:
        that:
          - volume_idempotent.changed == false
          - volume_idempotent.old_state == "present"
          - volume_idempotent.actions | length == 0
        fail_msg: "Volume should not have changed"
        
    - name: Test 8 - Delete volume (check mode)
      community.general.lxd_storage:
        name: "{{ test_volume }}"
        type: volume
        pool: "{{ test_pool }}"
        state: absent
        snap_url: "{{ lxd_socket }}"
      check_mode: true
      register: volume_delete_check
      
    - name: Verify volume check mode deletion
      assert:
        that:
          - volume_delete_check.changed == true
          - volume_delete_check.old_state == "present"
          - "'delete' in volume_delete_check.actions"
        fail_msg: "Check mode should show deletion intent"
        
    - name: Test 9 - Delete volume (actual)
      community.general.lxd_storage:
        name: "{{ test_volume }}"
        type: volume
        pool: "{{ test_pool }}"
        state: absent
        snap_url: "{{ lxd_socket }}"
      register: volume_delete
      
    - name: Verify volume deletion
      assert:
        that:
          - volume_delete.changed == true
          - volume_delete.old_state == "present"
          - "'delete' in volume_delete.actions"
        fail_msg: "Volume should have been deleted"
        
    - name: Test 10 - Delete pool
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        state: absent
        snap_url: "{{ lxd_socket }}"
      register: pool_delete
      
    - name: Verify pool deletion
      assert:
        that:
          - pool_delete.changed == true
          - pool_delete.old_state == "present"
          - "'delete' in pool_delete.actions"
        fail_msg: "Pool should have been deleted"
        
    - name: Test 11 - Delete idempotency (pool already gone)
      community.general.lxd_storage:
        name: "{{ test_pool }}"
        type: pool
        state: absent
        snap_url: "{{ lxd_socket }}"
      register: pool_delete_idempotent
      
    - name: Verify deletion idempotency
      assert:
        that:
          - pool_delete_idempotent.changed == false
          - pool_delete_idempotent.old_state == "absent"
          - pool_delete_idempotent.actions | length == 0
        fail_msg: "Pool deletion should be idempotent"
        
    - name: "=== ALL TESTS PASSED ==="
      debug:
        msg: |
          ✓ Check mode works correctly
          ✓ Storage pools can be created
          ✓ Storage pools can be updated
          ✓ Storage pools show idempotency
          ✓ Storage volumes can be created
          ✓ Storage volumes can be updated
          ✓ Storage volumes show idempotency
          ✓ Storage volumes can be deleted
          ✓ Storage pools can be deleted
          ✓ Deletion is idempotent
          
          All 11 integration tests passed!
